<!DOCTYPE html PUBLIC ""
    "">

<html><head><meta charset="UTF-8" /><title>riemann.streams.pure documentation</title><link rel="stylesheet" type="text/css" href="css/default.css" /><link rel="stylesheet" type="text/css" href="css/highlight.css" /><script type="text/javascript" src="js/highlight.min.js"></script><script type="text/javascript" src="js/jquery.min.js"></script><script type="text/javascript" src="js/page_effects.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div id="header"><h2>Generated by <a href="https://github.com/weavejester/codox">Codox</a></h2><h1><a href="index.html"><span class="project-title"><span class="project-name">Riemann</span> <span class="project-version">0.3.12</span></span></a></h1></div><div class="sidebar primary"><h3 class="no-link"><span class="inner">Project</span></h3><ul class="index-link"><li class="depth-1 "><a href="index.html"><div class="inner">Index</div></a></li></ul><h3 class="no-link"><span class="inner">Namespaces</span></h3><ul><li class="depth-1"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>riemann</span></div></div></li><li class="depth-2 branch"><a href="riemann.bin.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>bin</span></div></a></li><li class="depth-2 branch"><a href="riemann.blueflood.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>blueflood</span></div></a></li><li class="depth-2 branch"><a href="riemann.boundary.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>boundary</span></div></a></li><li class="depth-2 branch"><a href="riemann.clickhouse.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>clickhouse</span></div></a></li><li class="depth-2 branch"><a href="riemann.cloudwatch.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>cloudwatch</span></div></a></li><li class="depth-2 branch"><a href="riemann.common.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>common</span></div></a></li><li class="depth-2 branch"><a href="riemann.config.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>config</span></div></a></li><li class="depth-2 branch"><a href="riemann.core.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>core</span></div></a></li><li class="depth-2 branch"><a href="riemann.datadog.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>datadog</span></div></a></li><li class="depth-2 branch"><a href="riemann.deps.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>deps</span></div></a></li><li class="depth-2 branch"><a href="riemann.druid.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>druid</span></div></a></li><li class="depth-2 branch"><a href="riemann.elasticsearch.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>elasticsearch</span></div></a></li><li class="depth-2 branch"><a href="riemann.email.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>email</span></div></a></li><li class="depth-2 branch"><a href="riemann.expiration.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>expiration</span></div></a></li><li class="depth-2 branch"><a href="riemann.folds.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>folds</span></div></a></li><li class="depth-2 branch"><a href="riemann.graphite.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>graphite</span></div></a></li><li class="depth-2 branch"><a href="riemann.hipchat.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>hipchat</span></div></a></li><li class="depth-2 branch"><a href="riemann.index.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>index</span></div></a></li><li class="depth-2 branch"><a href="riemann.influxdb.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>influxdb</span></div></a></li><li class="depth-2 branch"><a href="riemann.influxdb2.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>influxdb2</span></div></a></li><li class="depth-2 branch"><a href="riemann.instrumentation.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>instrumentation</span></div></a></li><li class="depth-2 branch"><a href="riemann.kafka.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>kafka</span></div></a></li><li class="depth-2 branch"><a href="riemann.kairosdb.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>kairosdb</span></div></a></li><li class="depth-2 branch"><a href="riemann.keenio.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>keenio</span></div></a></li><li class="depth-2 branch"><a href="riemann.librato.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>librato</span></div></a></li><li class="depth-2 branch"><a href="riemann.logentries.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>logentries</span></div></a></li><li class="depth-2 branch"><a href="riemann.logging.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>logging</span></div></a></li><li class="depth-2 branch"><a href="riemann.logstash.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>logstash</span></div></a></li><li class="depth-2 branch"><a href="riemann.mailgun.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>mailgun</span></div></a></li><li class="depth-2 branch"><a href="riemann.msteams.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>msteams</span></div></a></li><li class="depth-2 branch"><a href="riemann.nagios.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>nagios</span></div></a></li><li class="depth-2 branch"><a href="riemann.netuitive.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>netuitive</span></div></a></li><li class="depth-2 branch"><a href="riemann.opentsdb.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>opentsdb</span></div></a></li><li class="depth-2 branch"><a href="riemann.opsgenie.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>opsgenie</span></div></a></li><li class="depth-2 branch"><a href="riemann.pagerduty.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>pagerduty</span></div></a></li><li class="depth-2 branch"><a href="riemann.plugin.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>plugin</span></div></a></li><li class="depth-2 branch"><a href="riemann.pool.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>pool</span></div></a></li><li class="depth-2 branch"><a href="riemann.prometheus.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>prometheus</span></div></a></li><li class="depth-2 branch"><a href="riemann.pubsub.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>pubsub</span></div></a></li><li class="depth-2 branch"><a href="riemann.pushover.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>pushover</span></div></a></li><li class="depth-2 branch"><a href="riemann.query.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>query</span></div></a></li><li class="depth-2 branch"><a href="riemann.rabbitmq.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>rabbitmq</span></div></a></li><li class="depth-2 branch"><a href="riemann.repl.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>repl</span></div></a></li><li class="depth-2 branch"><a href="riemann.service.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>service</span></div></a></li><li class="depth-2 branch"><a href="riemann.shinken.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>shinken</span></div></a></li><li class="depth-2 branch"><a href="riemann.slack.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>slack</span></div></a></li><li class="depth-2 branch"><a href="riemann.sns.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>sns</span></div></a></li><li class="depth-2 branch"><a href="riemann.stackdriver.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>stackdriver</span></div></a></li><li class="depth-2"><a href="riemann.streams.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>streams</span></div></a></li><li class="depth-3 current"><a href="riemann.streams.pure.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>pure</span></div></a></li><li class="depth-2 branch"><a href="riemann.telegram.html"><div class="inner"><span class="tree" style="top: -52px;"><span class="top" style="height: 61px;"></span><span class="bottom"></span></span><span>telegram</span></div></a></li><li class="depth-2 branch"><a href="riemann.test.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>test</span></div></a></li><li class="depth-2"><a href="riemann.time.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>time</span></div></a></li><li class="depth-3"><a href="riemann.time.controlled.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>controlled</span></div></a></li><li class="depth-2"><a href="riemann.transport.html"><div class="inner"><span class="tree" style="top: -52px;"><span class="top" style="height: 61px;"></span><span class="bottom"></span></span><span>transport</span></div></a></li><li class="depth-3 branch"><a href="riemann.transport.debug.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>debug</span></div></a></li><li class="depth-3 branch"><a href="riemann.transport.graphite.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>graphite</span></div></a></li><li class="depth-3 branch"><a href="riemann.transport.opentsdb.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>opentsdb</span></div></a></li><li class="depth-3 branch"><a href="riemann.transport.rabbitmq.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>rabbitmq</span></div></a></li><li class="depth-3 branch"><a href="riemann.transport.sse.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>sse</span></div></a></li><li class="depth-3 branch"><a href="riemann.transport.tcp.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>tcp</span></div></a></li><li class="depth-3 branch"><a href="riemann.transport.udp.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>udp</span></div></a></li><li class="depth-3"><a href="riemann.transport.websockets.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>websockets</span></div></a></li><li class="depth-2 branch"><a href="riemann.twilio.html"><div class="inner"><span class="tree" style="top: -269px;"><span class="top" style="height: 278px;"></span><span class="bottom"></span></span><span>twilio</span></div></a></li><li class="depth-2 branch"><a href="riemann.victorops.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>victorops</span></div></a></li><li class="depth-2 branch"><a href="riemann.xymon.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>xymon</span></div></a></li><li class="depth-2"><a href="riemann.zabbix.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>zabbix</span></div></a></li></ul></div><div class="sidebar secondary"><h3><a href="#top"><span class="inner">Public Vars</span></a></h3><ul></ul></div><div class="namespace-docs" id="content"><h1 class="anchor" id="top">riemann.streams.pure</h1><div class="doc"><div class="markdown"><p>Riemann streams have performed exceptionally well, but their design scope was intentionally limited. Users consistently request:</p>
<ul>
<li>Consistent behavior with respect to time intervals</li>
<li>Persisting stream state across reloads and process restarts</li>
<li>Replicating streams across multiple nodes</li>
</ul>
<p>These suggest:</p>
<ul>
<li>
<p>Streams should be atomically coerceable to data structures for storage and exchange between nodes.</p>
</li>
<li>
<p>Streams need globally unique identifiers so we can handle multiple streams feeding into the same child stream.</p>
</li>
<li>
<p>Streams should be deterministic functions of their input events, instead of depending on wall-clock time.</p>
</li>
<li>
<p>Streams should be as pure as possible–side effect should be explicitly identified and controlled for distribution and replayability.</p>
</li>
</ul>
<p>And we wish to preserve:</p>
<ul>
<li>
<p>Performance: tens of millions of events per second is nice.</p>
</li>
<li>
<p>Implicit parallelism: it’s easy to get determinism in a single thread, but we can and should do better.</p>
</li>
<li>
<p>The existing stream syntax, including macros like (by).</p>
</li>
</ul>
<p>Useful existing assumptions:</p>
<ul>
<li>Events are roughly time-ordered, and we have no problem rejecting events that appear too far outside our latency window.</li>
</ul>
<p>New assumptions:</p>
<ul>
<li>
<p>Events are uniquely identified by <a href="host, service, time, seq">host, service, time, seq</a> identifiers.</p>
</li>
<li>
<p>Events are deterministically partitioned into time windows. Windows are monotonically advancing; all streams see windows in strictly sequential order.</p>
</li>
</ul>
<h2><a href="#ideas-on-time" id="ideas-on-time"></a>Ideas on Time</h2>
<p>Peter Alvaro has convinced me of the obvious (lol) idea that a distributed stream processor must have some way to <em>seal</em> the events–to tell when a given stream has seen all inputs for a particular interval, so that it can in turn send state downstream.</p>
<p>Presently, sealing is performed as a global side effect from the riemann.time scheduler, which causes weird latency anomalies–for instance, chaining 3 windows together introduces 3x window latency, and if multiple streams are recombined we’ll happily interleave events from different times. Also, this fucks with determinism.</p>
<p>I think the right move is to thread sealing information through the same paths that connect streams to one another, but this introduces a new problem. Right now, Riemann streams only have links to their children, not their parents. In order for a stream to know it’s received all its inputs, it must know how many producers are sending it messages.</p>
<p>We could do this by sending an ‘initiation pulse’ through the topology, where each parent informs its child that it exists. Happily, producer relationships are local, not global: a stream only has to know about its immediate producers.</p>
<p>A difficulty: (by) creates producers dynamically. I THINK this is the only place where Riemann topologies shift at runtime. Can we figure out a solution that works for (by)?</p>
<p>A specific case: (by) has one child stream c0, which has events for the current window w0. (by) receives an event e which creates a new child stream c0. All child streams unify at a final stream f.</p>
<pre><code>  /--- c0 ---\
by            f
  \--- c1 ---/
</code></pre>
<p>Case 1: e falls in w0. Create child c1 and inform it that the current window is w0. c1 sends an initiation pulse for w0 to f, causing f to increment its producer count for w0. If by can only seal w0 once c1’s initiation pulse has completely propagated, f will not seal w0 until c1 has had a chance to forward its w0 events to f as well.</p>
<p>Case 2: e falls in w1. Seal w0 and inform c0 as usual. Move to window w1, create c1 and proceed as in Case 1.</p>
<p>Implication: initiation and sealing pulses require synchronous acknowledgement–we have to wait for the initiation to propagate all the way downstream to make sure that every downstream node is aware of its new producer. It’s fine to emit events concurrently (cuz the stream may be able to do parallel processing) so long as sealing is strictly ordered.</p>
<p>Another implication: Sealing pulses must be ordered w.r.t the event stream. We have to acquire something like a ReaderWriterLock to ensure no threads are operating on our children while we seal them. That means acquiring a readlock on every. single. event. Fuck.</p>
<p>Alternate strategy: queues between everything. We are going for CSP invariants, after all, and that’s what Akka does! That means locks AND allocations and pointer chasing for every event. Fuck no.</p>
<p>Alternate strategy: most configs involve tens of branches. Branches can execute in parallel: we could enforce a single-thread-per-branch rule. When branches recombine, though, we gotta introduce a queue or a lock. Seems less bad. OTOH, if only one thread can ever execute a given stream, we can stop using atoms and move all stream state to volatile mutables, which could dramatically reduce memory barriers. And the initiation pulses tell us when we need locks: if you only have one producer, you don’t need to lock.</p>
<p>If we use queues and enforce strict thread affinity for streams, we could get away with unsynchronized mutables, not just volatile ones.</p>
<p>UGH</p>
</div></div></div></body></html>